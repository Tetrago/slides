from manim import *
from manim_slides import Slide


class Main(Slide):

    def title(self):
        title = Text("Binary Exploitation", font_size=56)
        left = Line([0, 0, 0], [-4, 0, 0])
        right = Line([0, 0, 0], [4, 0, 0])

        self.play(Create(left), Create(right))
        self.play(FadeIn(title), title.animate.shift(UP * 0.3),
                  left.animate.shift(DOWN * 0.3),
                  right.animate.shift(DOWN * 0.3))
        self.next_slide()
        self.play(Uncreate(title), Uncreate(left), Uncreate(right))

    def program_stack(self):
        title = Text("Program Stack").to_edge(UP, buff=0.5)
        stack = Rectangle(height=5, width=4)

        self.play(Create(stack), Write(title))

        top = Line(stroke_opacity=0).move_to(stack, UP)
        top.width = 4

        bp_arrow = Arrow(start=LEFT, end=RIGHT)
        bp_text = Text("Base Pointer", font_size=16).next_to(bp_arrow, LEFT)
        bp = Group(bp_arrow, bp_text).next_to(top, LEFT)

        sp_arrow = Arrow(start=RIGHT, end=LEFT)
        sp_text = Text("Stack Pointer", font_size=16).next_to(sp_arrow, RIGHT)
        sp = Group(sp_arrow, sp_text).next_to(top, RIGHT)

        self.play(Create(bp_arrow), AddTextLetterByLetter(bp_text),
                  Create(sp_arrow), AddTextLetterByLetter(sp_text))
        self.next_slide()

        frames = []
        group = Group(stack, top, bp, sp)

        def push_frame(name, color, height=1):
            rect = Rectangle(height=height,
                             width=4,
                             fill_opacity=1,
                             fill_color=color)

            text = Text(name, font_size=24).move_to(rect)
            frame = VGroup(rect, text).to_edge(RIGHT, buff=1)

            if len(frames) == 0:
                frame.move_to(stack, UP)
            else:
                frame.next_to(frames[-1][1], DOWN, buff=0)

            top = Line(stroke_opacity=0).move_to(rect, UP)
            top.width = 4

            bottom = Line(stroke_opacity=0).move_to(rect, DOWN)
            bottom.width = 4

            if len(frames) != 0:
                self.play(bp.animate.next_to(top, LEFT))

            self.play(GrowFromEdge(frame.stretch_to_fit_width(4), UP),
                      sp.animate.next_to(bottom, RIGHT))

            group.add(top)
            group.add(frame)
            group.add(bottom)

            frames.append((top, frame, bottom))

        def pop_frame():
            frame = frames[-1]
            frames.pop()

            self.play(sp.animate.next_to(frame[0], RIGHT), FadeOut(frame[1]))

            group.remove(frame[0])
            group.remove(frame[1])
            group.remove(frame[2])

            if len(frames) == 0:
                self.play(bp.animate.next_to(top, LEFT))
            else:
                self.play(bp.animate.next_to(frames[-1][0], LEFT))

        push_frame("Main", "#E6194B")
        self.next_slide()

        push_frame("Function A", "#3CB44B")
        push_frame("Function B", "#FFE119", 2)
        push_frame("Function C", "#4363D8", 0.5)
        self.next_slide()

        pop_frame()
        self.next_slide()

        pop_frame()
        pop_frame()
        pop_frame()
        self.next_slide()

        bp_arrow = Arrow(start=LEFT, end=RIGHT, buff=0.8)
        bp_text = Text("rbp", font_size=16).next_to(bp_arrow, LEFT)
        bp_group = Group(bp_arrow, bp_text).next_to(top, LEFT)

        sp_arrow = Arrow(start=RIGHT, end=LEFT, buff=0.8)
        sp_text = Text("rsp", font_size=16).next_to(sp_arrow, RIGHT)
        sp_group = Group(sp_arrow, sp_text).next_to(top, RIGHT)

        self.play(ReplacementTransform(bp, bp_group),
                  ReplacementTransform(sp, sp_group))

        group.remove(bp)
        bp = bp_group
        group.add(bp)

        group.remove(sp)
        sp = sp_group
        group.add(sp)

        src = Code("program_stack.asm",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=20).to_edge(RIGHT, buff=-3)

        self.play(group.animate.to_edge(LEFT, buff=1.5),
                  src.animate.to_edge(RIGHT, buff=1))
        self.next_slide()

        push_frame("main", "#E6194B")
        push_frame("procedure", "#3CB44B")
        self.next_slide()

        pop_frame()
        pop_frame()
        self.next_slide()

        self.play(FadeOut(group), FadeOut(src), Unwrite(title))

    def stack_frame(self):
        title = Text("Stack Frame").to_edge(UP, buff=0.5)
        self.play(Write(title))

        rect = Rectangle(width=4, height=5)
        self.play(Create(rect))

        hlines = VGroup(
            *[Line([-2.0, 0.0, 0.0], [2.0, 0.0, 0.0])
              for _ in range(10)]).arrange(DOWN, buff=0.5).move_to(rect, UP)

        hlabels = VGroup(*[
            Text(f'0x7f..{0xff-i*8:02x}',
                 font_size=18,
                 font="Monaspace Neon",
                 color="#666666") for i in range(10)
        ]).arrange(DOWN, buff=0.3).next_to(rect, LEFT)

        vlines = Group(
            *[Line([0.0, 2.5, 0.0], [0.0, -2.5, 0.0])
              for _ in range(8)]).arrange(LEFT, buff=0.5).move_to(rect, RIGHT)

        vlabels = Group(*[
            Text(f'{i}', font_size=18, color="#666666", font="Monaspace Neon")
            for i in range(8)
        ]).arrange(LEFT, buff=0.38).next_to(rect, UP, buff=0.1)

        group = Group(rect, hlines, hlabels, vlines, vlabels)

        self.play(LaggedStartMap(Create, hlines, lag_ratio=0.2),
                  LaggedStartMap(Create, hlabels, lag_ratio=0.2))

        self.play(LaggedStartMap(Create, vlines, lag_ratio=0.2),
                  LaggedStartMap(Create, vlabels, lag_ratio=0.2))

        self.next_slide()

        src = Code("stack_frame.c",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=20).to_edge(RIGHT, buff=1)

        self.play(group.animate.to_edge(LEFT, buff=1.5))
        self.play(AddTextWordByWord(src))
        self.next_slide()

        rip_rect = Rectangle(width=4,
                             height=0.5,
                             fill_color="#E6194B",
                             fill_opacity=1)
        rip_text = Text("rip", font_size=22).move_to(rip_rect)
        rip = Group(rip_rect, rip_text).move_to(rect, UP)

        self.play(FadeIn(rip_rect), FadeIn(rip_text))
        self.next_slide()

        rbp_rect = Rectangle(width=4,
                             height=0.5,
                             fill_color="#3CB44B",
                             fill_opacity=1)
        rbp_text = Text("rbp", font_size=22).move_to(rbp_rect)
        rbp = Group(rbp_rect, rbp_text).move_to(rect, UP).shift(DOWN * 0.5)

        self.play(FadeIn(rbp_rect), FadeIn(rbp_text))
        self.next_slide()

        valid_rect = Rectangle(width=0.5,
                               height=0.5,
                               fill_color="#FFE119",
                               fill_opacity=1).move_to(
                                   rect, UP).shift(LEFT * 1.75 + DOWN)
        self.play(FadeIn(valid_rect))
        self.next_slide()

        magic_number_rect = Rectangle(width=2,
                                      height=0.5,
                                      fill_color="#4363D8",
                                      fill_opacity=1)
        magic_number_labels = Group(*[
            Text(v, font_size=18, font="Monaspace Neon")
            for v in ["12", "34", "56", "78"]
        ]).arrange(LEFT, buff=0.23).move_to(magic_number_rect,
                                            RIGHT).shift(LEFT * 0.1)
        magic_number = Group(magic_number_rect, magic_number_labels).move_to(
            rect, UP).shift(DOWN + RIGHT)

        self.play(FadeIn(magic_number_rect),
                  LaggedStartMap(FadeIn, magic_number_labels, lag_ratio=0.2))
        self.next_slide()

        input_1 = Rectangle(width=4,
                            height=0.5,
                            fill_color="#FFE119",
                            fill_opacity=1).move_to(rect, UP).shift(DOWN * 1.5)
        input_2 = Rectangle(width=2,
                            height=0.5,
                            fill_color="#FFE119",
                            fill_opacity=1).move_to(rect,
                                                    UP).shift(DOWN * 2 + LEFT)
        input_3 = Line([-2, 0, 0], [0, 0, 0], stroke_color="#FFE119").move_to(
            rect, UP).shift(DOWN * 2 + LEFT)
        self.play(FadeIn(input_1), FadeIn(input_2), FadeIn(input_3))
        self.next_slide()

        pointless = Rectangle(width=4,
                              height=0.5,
                              fill_color="#4363D8",
                              fill_opacity=1).move_to(rect,
                                                      UP).shift(DOWN * 2.5)
        self.play(FadeIn(pointless))
        self.next_slide()

        self.play(
            title.animate.shift(LEFT * 20),
            group.animate.shift(LEFT * 20),
            src.animate.shift(LEFT * 20),
            rip.animate.shift(LEFT * 20),
            rbp.animate.shift(LEFT * 20),
            valid_rect.animate.shift(LEFT * 20),
            magic_number.animate.shift(LEFT * 20),
            input_1.animate.shift(LEFT * 20),
            input_2.animate.shift(LEFT * 20),
            input_3.animate.shift(LEFT * 20),
            pointless.animate.shift(LEFT * 20),
        )

    def buffer_overflow(self):
        title = Text("Buffer Overflow")
        self.play(Write(title))
        self.next_slide()

        self.play(title.animate.to_edge(UP, buff=1))

        buffer_rect = Rectangle(width=8, height=0.5)
        buffer_lines = Group(
            *[Line([0, 0.25, 0], [0, -0.25, 0]) for _ in range(16)]).arrange(
                RIGHT, buff=0.5).move_to(buffer_rect, LEFT)

        self.play(
            LaggedStart(Create(buffer_rect),
                        LaggedStartMap(Create, buffer_lines, lag_ratio=0.2),
                        lag_ratio=0.4))
        self.next_slide()

        buffer_obj = Rectangle(width=0.01,
                               height=0.5,
                               fill_color="#E6194B",
                               fill_opacity=1).shift(LEFT * 4)
        self.play(buffer_obj.animate.shift(RIGHT * 2).stretch_to_fit_width(4))
        self.play(buffer_obj.animate.shift(RIGHT * 2).stretch_to_fit_width(8))
        self.play(buffer_obj.animate.shift(LEFT * 3).stretch_to_fit_width(2))
        self.next_slide()

        label_arrow = Arrow(start=DOWN, end=UP).next_to(buffer_rect,
                                                        DOWN).shift(LEFT * 4)
        label = Text('char* buffer', font="Monaspace Neon",
                     font_size=18).next_to(label_arrow, DOWN)

        src = Code("buffer_overflow.c",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=24).to_edge(DOWN)

        buffer_labels = Group(
            *[
                Text(f"{x:x}", font_size=18, font="Monaspace Neon")
                for x in range(16)
            ], ).arrange(RIGHT, buff=0.375).move_to(
                buffer_rect, LEFT).shift(UP * 0.5 + RIGHT * 0.2)

        self.play(Create(src))
        self.play(Create(label_arrow), Create(label))
        self.play(LaggedStartMap(Create, buffer_labels, lag_ratio=0.2))
        self.next_slide()

        overlap_line = Line([0, 0.25, 0],
                            [0, -0.25, 0]).move_to(buffer_rect, RIGHT)
        self.add(overlap_line)

        self.play(buffer_obj.animate.shift(RIGHT * 5).stretch_to_fit_width(12))
        self.next_slide()

        self.play(Uncreate(title), Uncreate(buffer_rect),
                  AnimationGroup(*[Uncreate(x) for x in buffer_lines]),
                  Uncreate(buffer_obj), Uncreate(label_arrow), Uncreate(label),
                  Uncreate(src),
                  AnimationGroup(*[Uncreate(x) for x in buffer_labels]),
                  Uncreate(overlap_line))

    def basic_examples(self):
        src = Code("example1.c",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=24)

        self.play(Create(src))
        self.wait(0.25)
        self.next_slide()

        out = Code("example1.txt",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   font_size=24).to_edge(RIGHT, buff=2)

        self.play(src.animate.to_edge(LEFT, buff=2))
        self.play(FadeIn(out))
        self.next_slide()

        self.play(src.animate.to_edge(LEFT, buff=-7),
                  out.animate.to_edge(RIGHT, buff=-7))

        src = Code("example2.c",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=24)

        self.play(Create(src))
        self.wait(0.25)
        self.next_slide()

        buffer_rect = Rectangle(width=4,
                                height=2,
                                fill_color="#FFE119",
                                fill_opacity=1)
        buffer_label = Text("buffer", font_size=22).move_to(buffer_rect)
        buffer = VGroup(buffer_rect, buffer_label)

        rbp_rect = Rectangle(width=4,
                             height=0.5,
                             fill_color="#3CB44B",
                             fill_opacity=1)
        rbp_label = Text("rbp", font_size=22).move_to(rbp_rect)
        rbp = VGroup(rbp_rect, rbp_label).next_to(buffer, UP, buff=0)

        rip_rect = Rectangle(width=4,
                             height=0.5,
                             fill_color="#E6194B",
                             fill_opacity=1)
        rip_label = Text("rip", font_size=22).move_to(rip_rect)
        rip = VGroup(rip_rect, rip_label).next_to(rbp, UP, buff=0)

        stack = VGroup(buffer, rbp, rip).to_edge(RIGHT, buff=1).shift(UP * 0.5)

        self.play(src.animate.to_edge(LEFT, buff=1.5))
        self.play(
            LaggedStart(AnimationGroup(FadeIn(buffer_rect),
                                       FadeIn(buffer_label)),
                        AnimationGroup(FadeIn(rbp_rect), FadeIn(rbp_label)),
                        AnimationGroup(FadeIn(rip_rect), FadeIn(rip_label)),
                        lag_ratio=0.2))
        self.next_slide()

        rbp_over = Rectangle(width=4,
                             height=0.5,
                             fill_color="#000000",
                             fill_opacity=1).move_to(rbp)

        win_rect = Rectangle(width=4,
                             height=0.5,
                             fill_color="#4363D8",
                             fill_opacity=1).move_to(rip)
        win_label = Text("win", font_size=22).move_to(win_rect)

        self.play(
            LaggedStart(
                AnimationGroup(ReplacementTransform(rbp_rect, rbp_over),
                               Uncreate(rbp_label)),
                AnimationGroup(ReplacementTransform(rip_rect, win_rect),
                               ReplacementTransform(rip_label, win_label)),
                lag_ratio=0.2))
        self.next_slide()

        self.play(Uncreate(src), Uncreate(buffer_rect), Uncreate(buffer_label),
                  Uncreate(rbp_over), Uncreate(win_rect), Uncreate(win_label))

    def basic_pwntools(self):
        title = Text("pwntools")
        self.play(Write(title))
        self.next_slide()

        pip = Text("python3 -m pip install pwntools",
                   font="Monaspace Neon",
                   font_size=22,
                   fill_opacity=0)

        apt = Text("apt install python3-pwntools",
                   font="Monaspace Neon",
                   font_size=22).shift(DOWN)

        self.play(title.animate.shift(UP * 0.5),
                  pip.animate.shift(DOWN * 0.5).set_opacity(1))
        self.play(ReplacementTransform(pip.copy(), apt))
        self.next_slide()

        self.play(FadeOut(title), FadeOut(pip), FadeOut(apt))

        src = Code("example2.py",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=24)
        self.add(src)
        self.next_slide()

        rect = Rectangle(width=config.frame_width,
                         height=config.frame_height,
                         fill_color="#000000",
                         fill_opacity=1,
                         stroke_opacity=0)
        self.play(rect.animate.shift(DOWN * 3))
        self.next_slide()

        symbol = Rectangle(width=4,
                           height=0.5,
                           fill_color="#000000",
                           fill_opacity=1,
                           stroke_opacity=0).shift(RIGHT * 1.06 + DOWN * 0.88)
        self.add(symbol)

        self.play(rect.animate.shift(DOWN * 0.5))
        self.next_slide()

        self.play(rect.animate.shift(DOWN * 0.75))
        self.next_slide()

        self.play(rect.animate.shift(DOWN * 1.25))
        self.next_slide()

        self.play(symbol.animate.shift(RIGHT * 5))
        self.next_slide()

        self.play(rect.animate.shift(DOWN * 0.75))
        self.next_slide()

        self.play(rect.animate.shift(DOWN * 2))
        self.next_slide()

        out = Code("example2.txt",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   font_size=20).to_edge(RIGHT)

        self.play(src.animate.to_edge(LEFT))
        self.play(FadeIn(out))
        self.next_slide()

        self.play(*[Uncreate(x) for x in self.mobjects])

    def example3(self):
        src = Code("example3.c",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=19)
        self.play(Create(src))
        self.wait(0.25)
        self.next_slide()

        arrow = Arrow(start=LEFT, end=RIGHT).shift(UP * 0.37 + LEFT * 4.25)
        self.play(Create(arrow))
        self.next_slide()

        self.play(*[FadeOut(x) for x in self.mobjects])

    def rop_intro(self):
        a = Text("We have a problem.", fill_opacity=0,
                 font_size=36).shift(DOWN * 0.5)
        self.play(a.animate.shift(UP * 0.5).set_opacity(1))
        self.next_slide()

        b = Text("A `win` function is pretty rare.",
                 fill_opacity=0,
                 font_size=36).shift(DOWN * 0.5)
        self.play(
            a.animate.shift(UP * 0.5).set_opacity(0),
            b.animate.shift(UP * 0.5).set_opacity(1))
        self.next_slide()

        c = Text("How do we call a function with arguments?",
                 fill_opacity=0,
                 font_size=36).shift(DOWN * 0.5)
        self.play(
            b.animate.shift(UP * 0.5).set_opacity(0),
            c.animate.shift(UP * 0.5).set_opacity(1))
        self.next_slide()

        self.play(c.animate.shift(UP * 0.5).set_opacity(0))

    def rop(self):
        title = Text("Return Oriented Programming")
        rop = Text("(ROP)").shift(DOWN * 0.75)

        self.play(Write(title))
        self.play(Write(rop))
        self.next_slide()

        self.play(title.animate.to_edge(UP),
                  rop.animate.to_edge(UP, buff=1.25).set_opacity(0))

        text = Text('system("/bin/sh")',
                    t2c={
                        "system": "#11A219",
                        '"/bin/sh"': "#D91C08"
                    },
                    font="Monaspace Neon")

        self.play(Create(text))
        self.next_slide()

        arrow = Arrow(start=DOWN, end=UP).shift(DOWN * 1.2 + LEFT * 2)
        self.play(Create(arrow))
        self.next_slide()

        self.play(arrow.animate.shift(RIGHT * 3.4))
        self.next_slide()

        self.play(Uncreate(arrow))
        self.play(text.animate.shift(UP * 1.5))

        conv = Table(
            [["#1", "rdi"], ["#2", "rsi"], ["#3", "rdx"], ["#4", "rcx"],
             ["#5", "r8"], ["#6", "r9"], ["..", "stack"]],
            col_labels=[
                Text("Argument", font="Monaspace Neon", font_size=22),
                Text("Location", font="Monaspace Neon", font_size=22)
            ],
            v_buff=0.3,
            element_to_mobject_config={
                "font": "Monaspace Neon",
                "font_size": 18
            }).shift(DOWN * 1.5)

        self.play(Create(conv))
        self.wait(0.25)
        self.next_slide()

        self.play(text.animate.shift(LEFT * 12), conv.animate.shift(LEFT * 12))
        self.next_slide()

        text = Text("We need gadgets.", fill_opacity=0,
                    font_size=36).shift(DOWN * 0.5)
        self.play(text.animate.shift(UP * 0.5).set_opacity(1))
        self.next_slide()

        gadgets = Code("gadgets.txt",
                       insert_line_no=False,
                       font="Monaspace Neon",
                       background_stroke_width=0,
                       font_size=18).shift(DOWN * 12)

        self.play(text.animate.to_edge(UP, buff=1.3),
                  gadgets.animate.shift(UP * 11))
        self.next_slide()

        rect = Rectangle(width=5.5, height=0.3,
                         stroke_color="#E6194B").shift(UP * 1.57, LEFT * 4)
        self.play(Create(rect))
        self.next_slide()

        self.play(title.animate.shift(LEFT * 20),
                  text.animate.shift(LEFT * 20),
                  gadgets.animate.shift(LEFT * 20),
                  rect.animate.shift(LEFT * 20))

        def block(label, color, ins, prev=None):
            rect = Rectangle(width=6,
                             height=1,
                             fill_color=color,
                             fill_opacity=1)

            if prev is not None:
                rect.next_to(prev, UP, buff=0)
            else:
                rect.move_to(ORIGIN)

            label = Text(label, font="Monaspace Neon",
                         font_size=30).move_to(rect)
            i = Text(ins, font="Monaspace Neon",
                     font_size=30).next_to(rect, RIGHT)
            return Group(rect, label, i)

        vlines = VGroup(
            Line([-3, config.frame_height, 0], [-3, -config.frame_height, 0]),
            Line([3, config.frame_height, 0], [3, -config.frame_height, 0]))

        hlines = VGroup(*[
            Line([-3, 0, 0], [3, 0, 0])
            for _ in range(int(config.frame_height) * 2)
        ]).arrange(DOWN, buff=1)

        grid = VGroup(vlines, hlines)

        self.play(
            LaggedStart(*[Create(x) for x in vlines],
                        LaggedStartMap(Create, hlines, lag_ratio=0.2),
                        lag_ratio=0.4))

        rbp = block("rbp", "#FFE119", "pop rbp").shift(DOWN)
        ret = block("pop rdi ; ret", "#E6194B", "ret", rbp[0])
        rdi = block('"/bin/sh"', "#4363D8", "pop rdi", ret[0])
        system = block("system", "#3CB44B", "ret", rdi[0])
        group = Group(rbp, ret, rdi, system)
        arrow = Arrow(start=LEFT, end=RIGHT).next_to(ret, LEFT)
        rsp = Text("rsp", font="Monaspace Neon",
                   font_size=22).next_to(arrow, LEFT)

        self.play(
            LaggedStart(LaggedStartMap(FadeIn, [x[0] for x in group],
                                       lag_ratio=0.2),
                        AnimationGroup(
                            LaggedStartMap(Create, [x[1] for x in group],
                                           lag_ratio=0.2),
                            LaggedStartMap(Create, [x[2] for x in group],
                                           lag_ratio=0.2)),
                        lag_ratio=0.2))
        self.play(Create(arrow), Create(rsp))
        self.next_slide()

        self.play(grid.animate.shift(DOWN), group.animate.shift(DOWN))
        self.next_slide()

        self.play(grid.animate.shift(DOWN), group.animate.shift(DOWN))
        self.next_slide()

        self.play(*[FadeOut(x) for x in self.mobjects])

    def rop_pwntools(self):
        c = Code("rop.c",
                 insert_line_no=False,
                 font="Monaspace Neon",
                 background_stroke_width=0,
                 font_size=16)
        self.play(Create(c))
        self.wait(0.25)
        self.next_slide()

        out = Text('"Use 0x401040 to call /bin/sh"',
                   font="Monaspace Neon",
                   font_size=16,
                   fill_opacity=0).next_to(c, DOWN, buff=0)

        group = Group(c, out)

        self.play(c.animate.shift(UP * 0.25),
                  out.animate.shift(DOWN * 0.25).set_opacity(1))
        self.next_slide()

        py = Code("rop.py",
                  insert_line_no=False,
                  font="Monaspace Neon",
                  background_stroke_width=0,
                  font_size=16).to_edge(RIGHT)
        self.play(group.animate.to_edge(LEFT))
        self.play(Create(py))
        self.wait(0.25)
        self.next_slide()

        out = Code("rop.txt",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   font_size=16).to_edge(LEFT).shift(DOWN * 8)

        self.play(group.animate.shift(UP * 8), out.animate.shift(UP * 8))
        self.next_slide()

        self.play(*[x.animate.shift(LEFT * 15) for x in self.mobjects])
        self.remove(*self.mobjects)

    def virtual_memory(self):
        title = Text("Virtual Memory")
        self.play(Write(title))
        self.next_slide()

        self.play(title.animate.to_edge(UP))

        mem = Rectangle(width=3,
                        height=config.frame_height - 2).to_edge(DOWN, buff=0.5)

        low = Text("0x00...", font="Monaspace Neon",
                   font_size=18).move_to(mem, DOWN).shift(LEFT * 2.5)
        high = Text("0x7f...", font="Monaspace Neon",
                    font_size=18).move_to(mem, UP).shift(LEFT * 2.5)
        self.play(Create(mem))
        self.play(Create(low), Create(high))

        def make(label, color, height):
            rect = Rectangle(width=3,
                             height=height,
                             fill_color=color,
                             fill_opacity=1).move_to(ORIGIN)
            label = Text(label, font_size=22).move_to(rect)
            return Group(rect, label)

        program = make("Program", "#4363D8", 1)
        self.play(
            LaggedStart(Create(program[0]), Create(program[1]), lag_ratio=0.4))
        self.next_slide()

        stack = make("Stack", "#E6194B", 0.5).move_to(mem, UP)
        self.play(
            LaggedStart(Create(stack[0]), Create(stack[1]), lag_ratio=0.4))
        self.next_slide()

        data = make("Data", "#3CB44B", 0.5).move_to(mem, DOWN)
        self.play(LaggedStart(Create(data[0]), Create(data[1]), lag_ratio=0.4))
        self.next_slide()

        heap = make("Heap", "#FFE119", 1).next_to(data, UP, buff=0)
        self.play(LaggedStart(Create(heap[0]), Create(heap[1]), lag_ratio=0.4))
        self.next_slide()

        libc = make("libc", "#3CB44B", 0.5).next_to(stack, DOWN,
                                                    buff=0).shift(DOWN * 0.5)
        self.play(LaggedStart(Create(libc[0]), Create(libc[1]), lag_ratio=0.4))
        self.next_slide()

        where = Text("Where?", font_size=30).to_edge(DOWN, 0)
        self.play(Create(where))
        self.next_slide()

        self.play(stack.animate.shift(DOWN * 0.25),
                  libc.animate.shift(DOWN * 0.5), heap.animate.shift(UP),
                  data.animate.shift(UP * 0.5))
        self.next_slide()

        aslr = Text("Address Space Layout Randomization (ASLR)",
                    font_size=30).to_edge(DOWN, 0)
        self.play(ReplacementTransform(where, aslr))
        self.next_slide()

        pos_ind = Text("Position Independent Executable (PIE)",
                       font_size=30).to_edge(DOWN, 0)
        self.play(ReplacementTransform(aslr, pos_ind))
        self.next_slide()

        arrow = Arrow(start=LEFT, end=RIGHT).next_to(program, LEFT)
        no_pie = Text("No PIE", font_size=22).next_to(arrow, LEFT)
        self.play(Create(arrow), Create(no_pie))
        self.next_slide()

        pie = Text("PIE", font_size=22).next_to(arrow, LEFT).shift(DOWN * 0.5)
        self.play(program.animate.shift(DOWN * 0.5),
                  arrow.animate.shift(DOWN * 0.5),
                  ReplacementTransform(no_pie, pie))
        self.next_slide()

        self.play([FadeOut(x) for x in self.mobjects])

    def got_plt(self):
        got_label = Text("Global Offset Table (GOT) /",
                         fill_opacity=0).shift(UP * 0.25)
        plt_label = Text("Procedure Linkage Table (PLT)",
                         fill_opacity=0).shift(DOWN * 0.25)
        self.play(
            got_label.animate.shift(UP * 0.25).set_opacity(1),
            plt_label.animate.shift(DOWN * 0.25).set_opacity(1))
        self.next_slide()

        self.play(FadeOut(got_label), FadeOut(plt_label))

        mem = Rectangle(width=3, height=config.frame_height - 2)
        self.play(Create(mem))

        def make(label, color, height):
            rect = Rectangle(width=3,
                             height=height,
                             fill_color=color,
                             fill_opacity=1).move_to(ORIGIN)
            label = Text(label, font_size=22).move_to(rect)
            return Group(rect, label)

        program = make("Program", "#4363D8", 1)
        self.play(
            LaggedStart(Create(program[0]), Create(program[1]), lag_ratio=0.4))

        libc = make("libc", "#3CB44B", 0.5).next_to(program, UP,
                                                    buff=0).shift(UP)
        self.play(LaggedStart(Create(libc[0]), Create(libc[1]), lag_ratio=0.4))

        libc_arrow = Arrow(start=LEFT, end=RIGHT).next_to(libc, LEFT)
        question = Text("?", font_size=22).next_to(libc_arrow, LEFT)
        self.play(Create(libc_arrow), Create(question))
        self.next_slide()

        got = make("GOT", "#E6194B", 1).next_to(program, DOWN)
        self.play(LaggedStart(Create(got[0]), Create(got[1]), lag_ratio=0.4))

        plt = make("PLT", "#FFE119", 1).next_to(got, DOWN, buff=0)
        self.play(LaggedStart(Create(plt[0]), Create(plt[1]), lag_ratio=0.4))
        self.next_slide()

        prog_0 = Line(start=RIGHT, end=ORIGIN).next_to(program, LEFT, buff=0)
        prog_2 = Line(start=LEFT,
                      end=ORIGIN).add_tip().next_to(plt, LEFT,
                                                    buff=0).shift(DOWN * 0.25)
        prog_1 = Line(start=prog_0.get_end(), end=prog_2.get_start())
        self.play(
            Succession(Create(prog_0, rate_func=linear, run_time=0.25),
                       Create(prog_1, rate_func=linear, run_time=0.25),
                       Create(prog_2, rate_func=linear, run_time=0.25)))
        self.next_slide()

        got_0 = Line(start=ORIGIN, end=LEFT / 2).next_to(got, LEFT, buff=0)
        got_2 = Line(start=LEFT / 2,
                     end=ORIGIN).add_tip().next_to(plt, LEFT,
                                                   buff=0).shift(UP * 0.25)
        got_1 = Line(start=got_0.get_end(), end=got_2.get_start())
        self.play(
            Succession(Create(got_0, rate_func=linear, run_time=0.25),
                       Create(got_1, rate_func=linear, run_time=0.25),
                       Create(got_2, rate_func=linear, run_time=0.25)))
        self.next_slide()

        sys_0 = Line(start=ORIGIN,
                     end=RIGHT / 2).next_to(plt, RIGHT,
                                            buff=0).shift(DOWN * 0.25)
        sys_1 = Line(start=ORIGIN,
                     end=DOWN * 1.5).add_tip().next_to(sys_0.get_end(),
                                                       DOWN,
                                                       buff=0)
        self.play(
            Succession(Create(sys_0, rate_func=linear, run_time=0.25),
                       Create(sys_1, rate_func=linear, run_time=0.25)))
        self.next_slide()

        libc_0 = Line(start=ORIGIN,
                      end=RIGHT / 2).next_to(plt, RIGHT,
                                             buff=0).shift(UP * 0.25)
        libc_2 = Line(start=RIGHT / 2, end=ORIGIN).add_tip().next_to(libc,
                                                                     RIGHT,
                                                                     buff=0)
        libc_1 = Line(start=libc_0.get_end(), end=libc_2.get_start())
        self.play(
            Succession(Create(libc_0, rate_func=linear, run_time=0.25),
                       Create(libc_1, rate_func=linear, run_time=0.25),
                       Create(libc_2, rate_func=linear, run_time=0.25)))
        self.next_slide()

        got_label = Text("got[...]", font="Monaspace Neon",
                         font_size=22).next_to(libc_arrow, LEFT)
        self.play(ReplacementTransform(question, got_label))
        self.next_slide()

        self.play([FadeOut(x) for x in self.mobjects])

    def pwn_address(self):
        src = Code("pwn_address.py",
                   insert_line_no=False,
                   font="Monaspace Neon",
                   background_stroke_width=0,
                   font_size=30)
        self.play(Create(src))
        self.wait(0.25)
        self.next_slide()

        self.play(Uncreate(src))

    def tools(self):
        dbg_title = Text("Debugging").move_to(UP)
        dbg_0 = Text("gef", font_size=30).next_to(dbg_title, DOWN)
        dbg_1 = Text("pwntools", font_size=30).next_to(dbg_0, DOWN)
        self.play(
            Succession(Create(dbg_title, run_time=0.5),
                       Create(dbg_0, run_time=0.5), Create(dbg_1,
                                                           run_time=0.5)))
        self.wait(0.25)
        self.next_slide()

        rop_title = Text("Return Oriented Programming").move_to(UP * 1.5)
        rop_0 = Text("ROPgadget", font_size=30).next_to(rop_title, DOWN)
        rop_1 = Text("rp++", font_size=30).next_to(rop_0, DOWN)
        rop_2 = Text("ropper", font_size=30).next_to(rop_1, DOWN)
        self.play(
            Succession(
                ReplacementTransform(dbg_title, rop_title, run_time=0.5),
                ReplacementTransform(dbg_0, rop_0, run_time=0.5),
                ReplacementTransform(dbg_1, rop_1, run_time=0.5),
                Create(rop_2, run_time=0.5)))
        self.next_slide()

        self.play([FadeOut(x) for x in self.mobjects])

    def construct(self):
        self.title()
        self.program_stack()
        self.stack_frame()
        self.buffer_overflow()
        self.basic_examples()
        self.basic_pwntools()
        self.example3()
        self.rop_intro()
        self.rop()
        self.rop_pwntools()
        self.virtual_memory()
        self.got_plt()
        self.pwn_address()
        self.tools()

        Text("fin")

        self.wait()
